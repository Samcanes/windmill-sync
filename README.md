# This Repo was autogenerated by the GPT 4.1
# verify code for ur use case before copying.
# u can fork the repo and use it to sync with ur CE windmill
# create new folders in root for each workspace

# Windmill CE Multi-Workspace 2-Way Sync GitHub Action

This plugin provides a GitHub Action for 2-way syncing all Windmill CE workspaces with a GitHub repository.

## Features

- Syncs all workspaces (not just one)
- Handles full Windmill project structure
- Runs on push to main
- Minimal manual setup
- Auto-commits changes with workspace and timestamp

## Setup & Usage

### 1. Add your Windmill API token to GitHub

- Go to your repository‚Äôs **Settings ‚Üí Secrets and variables ‚Üí Actions**.
- Add a new secret named `WINDMILL_TOKEN` with your Windmill CE API token.

### 2. Organize your repo

- Place all Windmill workspace folders under `/windmill/` in your repository root.
- Each workspace should have its own subfolder, e.g.:
  ```
  /windmill/
    /workspace-1/
    /workspace-2/
    /wmill.yaml
  ```

### 3. Configure workspaces (optional)

- To explicitly list workspaces, create `/windmill/workspaces.json`:
  ```json
  {
    "workspaces": ["workspace-1", "workspace-2"]
  }
  ```
- Otherwise, the script will auto-detect subfolders in `/windmill/`.

### 4. Add the plugin files to your repository

- Add the `windmill-sync` folder, including:
  - `sync.sh`
  - `.github/workflows/windmill-sync.yml`
  - (this) `README.md`

### 5. On every push to `main`

- The GitHub Action will run, syncing all workspaces with your Windmill CE instance using the provided token.

### 6. Monitor sync status

- Check the **Actions** tab in your GitHub repository for logs and sync results.

### 7. No changes needed on your Windmill server

- The sync is managed entirely from your GitHub repository using the Windmill CLI and API token.

## File Overview

- `sync.sh`: Main sync script (installs CLI, sets up credentials, loops workspaces, pulls/pushes, commits).
- `.github/workflows/windmill-sync.yml`: GitHub Action workflow to run the sync on push.
- `README.md`: This file.

## Customization

- Edit `sync.sh` to change sync logic or error handling.

## Example `sync.sh`

```bash
#!/bin/bash
set -e

# Install Windmill CLI
WMILL_VERSION="v1.123.0"
curl -L "https://github.com/windmill-labs/windmill/releases/download/${WMILL_VERSION}/wmill-linux-amd64" -o /usr/local/bin/wmill
chmod +x /usr/local/bin/wmill

# Setup credentials
mkdir -p ~/.windmill
echo "{\"token\": \"${WINDMILL_TOKEN}\"}" > ~/.windmill/credentials.json

# Detect workspaces
WORKSPACES=()
if [ -f windmill/workspaces.json ]; then
  WORKSPACES=($(jq -r '.workspaces[]' windmill/workspaces.json))
else
  WORKSPACES=($(ls windmill | grep -v wmill.yaml))
fi

for WS in "${WORKSPACES[@]}"; do
  echo "Syncing workspace: $WS"
  cd windmill/$WS

  # Pull from Windmill
  wmill sync pull --workspace "$WS" || { echo "Pull failed for $WS"; exit 1; }

  # Check for changes
  if [ -n "$(git status --porcelain)" ]; then
    git add .
    git commit -m "üîÅ Sync from Windmill [$WS] at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  fi

  # Push to Windmill
  wmill sync push --workspace "$WS" || { echo "Push failed for $WS"; exit 1; }

  cd ../..
done
```

## Example `.github/workflows/windmill-sync.yml`

```yaml
name: Windmill 2-Way Sync

on:
  push:
    branches: [main]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up jq
        run: sudo apt-get install -y jq
      - name: Windmill 2-way sync
        env:
          WINDMILL_TOKEN: ${{ secrets.WINDMILL_TOKEN }}
        run: bash windmill-sync/sync.sh
      - name: Push changes
        run: |
          git push || echo "No changes to push"
```
